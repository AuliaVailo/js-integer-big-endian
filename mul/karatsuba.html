<!DOCTYPE html><html lang="en"><head><title>mul/karatsuba</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="mul/karatsuba"><meta name="groc-project-path" content="js/src/mul/karatsuba.js"><meta name="groc-github-url" content="https://github.com/aureooms/alu"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/aureooms/alu/blob/master/js/src/mul/karatsuba.js">js/src/mul/karatsuba.js</a></div></div><div id="document"><div class="segment"><div class="comments doc-section"><div class="wrapper"><p>/!\ BLOCK MULTIPLICATION RESULT MUST HOLD IN THE JAVASCRIPT NUMBER TYPE (DOUBLE i.e. 53 bits)</p>

<p>Parameters:</p>

<ul>
<li><p><strong>add must be a function.</strong><br/>(addition algorithm)</p></li>
<li><p><strong>sub must be a function.</strong><br/>(subtraction algorithm)</p></li>
<li><p><strong>mul must be a function.</strong><br/>(multiplication algorithm)</p></li>
<li><p><strong>copy must be a function.</strong><br/>(copy algorithm)</p></li>
<li><p><strong>num must be a prototype.</strong><br/>(array ctor)</p></li>
<li><p><strong>r must be an uint.</strong><br/>(base (radix) EXPLANATION ########### a.b = (a1.r^{n} + a0).(b1.r^{n} + b0) = a1.b1.r^{2n} + (a1.b0 + a0.b1).r^{n} + a0.b0 = z2.r^{2n} + z1.r^{n} + z0 z2 = a1.b1 z1 = a1.b0 + a0.b1 z0 = a0.b0 (a1 + a0)(b1 + b0) = a1.b1 + a0.b0 + (a1.b0 + a0.b1) = z2 + z0 + z1 z1 = (a1 + a0)(b1 + b0) - z2 - z0 AN ANOTHER WAY AROUND (not used here) (a1 - a0)(b1 - b0) = a1.b1 + a0.b0 - (a1.b0 + a0.b1) (a0 - a1)(b1 - b0) = (a1.b0 + a0.b1) - a1.b1 + a0.b0 a.b = (r^{2n} + r^{n})a1.b1 + r^{n}(a0 - a1)(b1 - b0) + (r^{n} + 1)a0.b0,)</p></li>
</ul></div></div><div class="code"><div class="wrapper"><span class="kd">var</span> <span class="nx">bkaratsuba_t</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">add</span><span class="p">,</span> <span class="nx">sub</span><span class="p">,</span> <span class="nx">mul</span><span class="p">,</span> <span class="nx">num</span><span class="p">,</span> <span class="nx">mov</span><span class="p">,</span> <span class="nx">r</span><span class="p">,</span> <span class="nx">wrap</span><span class="p">){</span></div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p>Multiply two big endian arrays using karatsuba algorithm,
i >= j, k >= 2 * i</p>

<p>Parameters:</p>

<ul>
<li><p><strong>a must be an array.</strong><br/>(first operand)</p></li>
<li><p><strong>i0 must be an int.</strong><br/>(a left)</p></li>
<li><p><strong>i1 must be an int.</strong><br/>(a right)</p></li>
<li><p><strong>b must be an array.</strong><br/>(second operand)</p></li>
<li><p><strong>j0 must be an int.</strong><br/>(b left)</p></li>
<li><p><strong>j1 must be an int.</strong><br/>(b right)</p></li>
<li><p><strong>c must be an array.</strong><br/>(result, must be 0 initialized)</p></li>
<li><p><strong>k0 must be an int.</strong><br/>(c left)</p></li>
<li><p><strong>k1 must be an int.</strong><br/>(c right)</p></li>
</ul></div></div><div class="code"><div class="wrapper">  <span class="kd">var</span> <span class="nx">karatsuba</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">i0</span><span class="p">,</span> <span class="nx">i1</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">j0</span><span class="p">,</span> <span class="nx">j1</span><span class="p">,</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">k0</span><span class="p">,</span> <span class="nx">k1</span><span class="p">){</span>

    <span class="kd">var</span> <span class="nx">z0</span><span class="p">,</span> <span class="nx">z2</span><span class="p">,</span> <span class="nx">t1</span><span class="p">,</span> <span class="nx">t2</span><span class="p">,</span> <span class="nx">t3</span><span class="p">,</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">I</span><span class="p">,</span> <span class="nx">P</span><span class="p">,</span> <span class="nx">P_</span><span class="p">,</span> <span class="nx">i_</span><span class="p">,</span> <span class="nx">j_</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">i1</span> <span class="o">-</span> <span class="nx">i0</span><span class="p">,</span>
    <span class="nx">j</span> <span class="o">=</span> <span class="nx">j1</span> <span class="o">-</span> <span class="nx">j0</span><span class="p">,</span>
    <span class="nx">k</span> <span class="o">=</span> <span class="nx">k1</span> <span class="o">-</span> <span class="nx">k0</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>EMPTY CASE</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span><span class="p">(</span><span class="nx">i</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">j</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">k</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>BASE CASE i = j = 1</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span><span class="p">(</span><span class="nx">i</span> <span class="o">===</span> <span class="mi">1</span><span class="p">){</span>
      <span class="nx">z0</span> <span class="o">=</span> <span class="nx">a</span><span class="p">[</span><span class="nx">i0</span><span class="p">]</span> <span class="o">*</span> <span class="nx">b</span><span class="p">[</span><span class="nx">j0</span><span class="p">];</span>
      <span class="nx">c</span><span class="p">[</span><span class="nx">k1</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">z0</span> <span class="o">%</span> <span class="nx">r</span><span class="p">;</span>

      <span class="k">if</span><span class="p">(</span><span class="nx">k</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
        <span class="nx">c</span><span class="p">[</span><span class="nx">k1</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nx">z0</span> <span class="o">-</span> <span class="nx">c</span><span class="p">[</span><span class="nx">k1</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="nx">r</span><span class="p">;</span>

    <span class="p">}</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>RECURSION</p></div></div><div class="code"><div class="wrapper">    <span class="k">else</span><span class="p">{</span>
      <span class="nx">p</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">ceil</span><span class="p">(</span><span class="nx">i</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
      <span class="nx">I</span> <span class="o">=</span> <span class="nx">i</span> <span class="o">+</span> <span class="nx">j</span><span class="p">;</span>
      <span class="nx">P</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="nx">p</span><span class="p">;</span>
      <span class="nx">P_</span> <span class="o">=</span> <span class="nx">I</span> <span class="o">-</span> <span class="nx">P</span><span class="p">;</span>
      <span class="nx">i_</span> <span class="o">=</span> <span class="nx">i1</span> <span class="o">-</span> <span class="nx">p</span><span class="p">;</span>
      <span class="nx">j_</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">j0</span><span class="p">,</span> <span class="nx">j1</span> <span class="o">-</span> <span class="nx">p</span><span class="p">);</span>

      <span class="nx">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">num</span><span class="p">(</span><span class="nx">p</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span> <span class="c1">// + 1 to handle addition overflows</span>
      <span class="nx">t2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">num</span><span class="p">(</span><span class="nx">p</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span> <span class="c1">// and guarantee reducing k for the</span>
      <span class="nx">t3</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">num</span><span class="p">(</span><span class="nx">P</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span> <span class="c1">// recursive calls</span>
      <span class="nx">z2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">num</span><span class="p">(</span><span class="nx">P_</span><span class="p">);</span>
      <span class="nx">z0</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">num</span><span class="p">(</span><span class="nx">P</span><span class="p">);</span>
      </div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>RECURSIVE CALLS</p></div></div><div class="code"><div class="wrapper">      <span class="nx">mul</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">i0</span><span class="p">,</span> <span class="nx">i_</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">j0</span><span class="p">,</span> <span class="nx">j_</span><span class="p">,</span> <span class="nx">z2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">P_</span><span class="p">);</span>            <span class="c1">// z2 = a1.b1</span>
      <span class="nx">mul</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">i_</span><span class="p">,</span> <span class="nx">i1</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">j_</span><span class="p">,</span> <span class="nx">j1</span><span class="p">,</span> <span class="nx">z0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">P</span><span class="p">);</span>             <span class="c1">// z0 = a0.b0</span>
      <span class="nx">add</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">i_</span><span class="p">,</span> <span class="nx">i1</span><span class="p">,</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">i0</span><span class="p">,</span> <span class="nx">i_</span><span class="p">,</span> <span class="nx">t1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>         <span class="c1">// (a0 + a1)</span>
      <span class="nx">add</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="nx">j0</span><span class="p">,</span> <span class="nx">j_</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">j_</span><span class="p">,</span> <span class="nx">j1</span><span class="p">,</span> <span class="nx">t2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>         <span class="c1">// (b1 + b0)</span>
      <span class="nx">mul</span><span class="p">(</span><span class="nx">t1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">t2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">t3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">P</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>   <span class="c1">// (a0 + a1)(b1 + b0)</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>BUILD OUTPUT</p></div></div><div class="code"><div class="wrapper">      <span class="nx">mov</span><span class="p">(</span><span class="nx">z2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">P_</span><span class="p">,</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">k1</span> <span class="o">-</span> <span class="nx">I</span><span class="p">);</span>                       <span class="c1">// + z2 . r^{2n}</span>
      <span class="nx">mov</span><span class="p">(</span><span class="nx">z0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">P</span> <span class="p">,</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">k1</span> <span class="o">-</span> <span class="nx">P</span><span class="p">);</span>                       <span class="c1">// + z0</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">t1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>                                        <span class="c1">// overflow on t1, add t2 . r^{p}</span>
      <span class="nx">add</span><span class="p">(</span><span class="nx">t3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">P</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">t2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">t3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">P</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="nx">p</span><span class="p">);</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">t2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>                                        <span class="c1">// overflow on t2, add t1 . r^{p}</span>
      <span class="nx">add</span><span class="p">(</span><span class="nx">t3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">P</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">t1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">t3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">P</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="nx">p</span><span class="p">);</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">t1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="nx">t2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>                               <span class="c1">// overflow on t1 and t2, add 1 . r^{p+1}</span>
      <span class="nx">add</span><span class="p">(</span><span class="nx">t3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">P</span> <span class="o">-</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">t1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">t3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">P</span> <span class="o">-</span> <span class="nx">p</span><span class="p">);</span>
      <span class="nx">add</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">k0</span><span class="p">,</span> <span class="nx">k1</span> <span class="o">-</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">t3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">P</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">k0</span><span class="p">,</span> <span class="nx">k1</span> <span class="o">-</span> <span class="nx">p</span><span class="p">);</span> <span class="c1">// + (a0 + a1)(b1 + b0) . r^{n}</span>
      <span class="nx">sub</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">k0</span><span class="p">,</span> <span class="nx">k1</span> <span class="o">-</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">z2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">P_</span><span class="p">,</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">k0</span><span class="p">,</span> <span class="nx">k1</span> <span class="o">-</span> <span class="nx">p</span><span class="p">);</span>    <span class="c1">// - z2 . r^{n}</span>
      <span class="nx">sub</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">k0</span><span class="p">,</span> <span class="nx">k1</span> <span class="o">-</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">z0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">P</span><span class="p">,</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">k0</span><span class="p">,</span> <span class="nx">k1</span> <span class="o">-</span> <span class="nx">p</span><span class="p">);</span>     <span class="c1">// - z1 . r^{n}</span>
    <span class="p">}</span>

  <span class="p">};</span>

  <span class="k">if</span><span class="p">(</span><span class="nx">wrap</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="nx">karatsuba</span> <span class="o">=</span> <span class="nx">wrap</span><span class="p">(</span><span class="nx">karatsuba</span><span class="p">);</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">mul</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="nx">mul</span> <span class="o">=</span> <span class="nx">karatsuba</span><span class="p">;</span>

  <span class="k">return</span> <span class="nx">karatsuba</span><span class="p">;</span>

<span class="p">};</span>


<span class="nx">exports</span><span class="p">.</span><span class="nx">bkaratsuba_t</span> <span class="o">=</span> <span class="nx">bkaratsuba_t</span><span class="p">;</span></div></div></div></div></body></html>